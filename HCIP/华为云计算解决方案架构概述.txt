09年，虚拟化。V1R3。FusionSphere
15年，V1R5。FusionCompute+FusionManager（统一的管理）
vmware市场老大。

16年,V1R6.0 6.1 引入openstack	FusionSphere 总体云计算解决方案
1、服务器虚拟化	FusionCompute(xen)+FusionManager	SV
2、云数据中心   FusionCompute(xen)+FusionSphere openstack	DC
3、电信运营商   KVM+FusionSphere openstack	NFVI

18年 V1R6.3
FusionSphere	服务器虚拟化 FusionCompute(kvm)+FusionManager
FusionCloud	私有云	KVM+FusionSphere openstack Manageone sc oc service om
FusionAccess	桌面云（15年FusionAccess 16年FusionCloud 18FusionAccess）



FusionSphere	华为（6.1）云计算总体解决方案
在云数据中心场景有云数据中心   FusionCompute(xen)+FusionSphere openstack

应用层：对外发布应用	管理：Managerone sc\oc

基础设施服务层：FusionSphere openstack+FusionManager。这两个产品都可以实现资源的统一管理（软硬件统一管理、异构虚拟化统一管理、异构硬件统一管理、不同数据中心统一管理等等功能）

通过驱动对接openstack

虚拟资源层：FusionCompute（计算虚拟化、存储虚拟化VIMS、网络虚拟化DVS）Fusionstorage（分布式存储，可以将X86服务器的硬盘组合成存储池）FusionNetwork（实际上不存在，目前是由Neutron+AC实现网络虚拟化）。以上是华为产品，也可以有其他友商的对应产品。

通过虚拟化技术，对上进行虚拟化

物理资源层：计算设备（X86服务器）存储设备（V3、V5等）网络设备（交换机、路由器等）安全设备


操作系统必须具备以下几个特征：
1、对接管理使用硬件
2、将硬件抽象化、逻辑化，成逻辑资源
3、软件、服务的生命周期管理
4、人机交互界面 图形化界面、命令行界面 
5、告警、系统配置、设置
openstack也能够做以上这几个事情，称之为云操作系统




虚拟化、云计算、云、云操作系统（openstack）

虚拟化：对硬件进行抽象、逻辑化、业务快速上线、提高资源利用率。大分小、小聚大

云计算：计算模式、商业模式、部署模式。。。服务化、自动化。

云：虚拟化+云操作系统

云操作系统：



FusionCompute:1、资源虚拟化（CNA）直接安装在服务器上	2、资源统一管理（VRM）安装在虚拟机上。实现计算、存储、网络虚拟化。


虚拟化的本质：
1、分区
2、隔离
3、封装
4、相对于硬件是独立的


guest os
host os


虚拟化类型：
1、寄居虚拟化：直接在宿主机操作系统安装虚拟化软件
优点：简单易于实现
缺点：在虚拟机上的应用程序使用资源，需要经过虚拟机操作系统->虚拟化层->宿主机操作系统->硬件，需要三次转换，性能开销、损耗较大
典型例子：vmware workstation\virtualbox

2、裸金属虚拟化：直接在物理硬件上，部署运行hypervisor
优点：相比第一种，性能开销较小，性能更好。
缺点：hypervisor本质上就是一个操作系统，开发难度较大
典型例子：vmware esx\esxi、xen、MS Hyper-v、华为FusionCompute（6.1及以前，基于xen）等等

3、混合虚拟化：特指kvm，在linux操作系统上，安装kvm模块，调用linux kernel，实现虚拟化。
kvm+kernel=hypervisor。某些资料上，会把kvm归到裸金属虚拟化上。
优点：相比裸金属虚拟化，只需要实现kvm，kernel直接调用linux,代码比较少，性能较好。
缺点：需要底层CPU支持硬件辅助虚拟化功能，intel vt-x  amd amd-v
例子：kvm

4、操作系统虚拟化：容器。多个容器共享操作系统。
优点：性能最好
缺点：容器与容器之间有可能会干扰，不安全
例子：docker k8s


xen 架构下的IO虚拟化

domain0：特权虚拟机，每个xen 的hypervisor只有一个
1、唯一拥有设备驱动，能够直接识别物理服务器上的设备
2、唯一拥有后端驱动，能够接收domainU上的前端驱动所发送的IO请求，分时分通道
3、最先启动，跟随主机启动而启动
4、domain0能够管理domainU虚拟机
domainU：普通虚拟机，可以有多个


domain0：
在安装主机过程中，主机Domain 0的最大VCPU个数为：物理服务器超线程数÷10，取值时需要向上取偶数值。预留VCPU个数与最大VCPU个数保持一致。
主机Domain 0内存大小按照如下条件进行配置：

    单个服务器内存≤96GB时，Domain 0内存大小设置为8GB。适用于单个主机最大提供50虚拟机、150虚拟磁盘或100虚拟网卡的规格。
    96GB<单个服务器内存≤192GB时，Domain 0内存大小为:单个服务器内存（GB）*0.05+8。适用于单个主机最大提供100虚拟机、300虚拟磁盘或200虚拟网卡的规格。
    单个服务器内存>192GB时，Domain 0内存大小为:单个服务器内存（GB）*0.05+8。适用于单个主机最大提供150虚拟机、450虚拟磁盘或300虚拟网卡的规格。

kvm 架构下的IO虚拟化
交给qemu实现。在没有装tools之前，用软件全模拟。在装tools之后，变成了vhost。性能得到提升。

安装并启动Tools后，用户无需做任何操作，Tools即可提供以下功能：

    为虚拟机提供高性能的磁盘I/O和网络I/O功能
    为虚拟机提供虚拟硬件监控功能
        获取虚拟机指定网卡IP信息
        获取虚拟机内部各CPU利用率、内存利用率
        获取虚拟机内各个磁盘/分区的空间使用信息
    为虚拟机提供高级功能
        迁移虚拟机
        安全关闭虚拟机、安全重启虚拟机、休眠虚拟机
        在线调整虚拟机的CPU规格
        创建虚拟机快照
        虚拟机蓝屏检测
        虚拟机与主机时钟同步
        虚拟机网卡的高级功能，如QoS
        自动升级虚拟机的驱动程序，如Tools驱动



cpu多核多线程
一颗物理CPU，里面可能多个内核。一个内核，可以有多个线程，只有双线程。
计算可用CPU资源时，不是以个数为单位，而是以主频为单位。并且要去dom0所占用的vcpu。

经典虚拟化
全虚拟化
半虚拟化
硬件辅助虚拟化


QOS：
1、CPU：限额：最大值 
	预留：最小值
	份额：竞争时按比例分得的资源
2、内存：限额：最大值 （只在6.3.1版本及后面才出现，但实际只能填写与虚拟机内存规格一样，实际没有意义）
	预留：最小值
	份额：竞争时按比例分得的资源
3、磁盘：磁盘最大IO上限
    最大读出字节数（KB/s）
    最大写入字节数（KB/s）
    最大读写字节数（KB/s）
    最大每秒读请求个数
    最大每秒写请求个数
    最大每秒读写请求个数
4、网络：端口组的发送、接收流量整形
	平均带宽、峰值带宽、突发大小。


内存复用：
1、内存共享、写时复制：虚拟机之间共享同一物理内存空间（蓝色），此时虚拟机仅对内存做只读操作。当虚拟机需要对内存进行写操作时（红色），开辟另一内存空间，并修改映射。
2、内存置换：虚拟机长时间未访问的内存内容被置换到存储中，并建立映射，当虚拟机再次访问该内存内容时再置换回来。
3、内存气泡：Hypervisor通过内存气泡将较为空闲的虚拟机内存释放给内存使用率较高的虚拟机，从而提升内存利用率。

华为虚拟化平台，通过智能复用以上三种技术可将内存复用比提升至130%。

内存复用开关默认是关闭。原因有二：
1、三项在使用过程中，会降低内存性能
2、超分配情况，超分配内存无法凭空产生，在重载情况下，有可能出现问题。

内存复用技术是综合复用。无法单独开启其中某项技术。

限制条件：
1、主机需配置足够的交换空间才能保证内存复用功能的稳定运行。（内存置换使用）
2、内存复用与SRIOV直通、GPU直通、NVME SSD盘直通特性互斥。（因为上述技术在使用时，会独占内存空间）
3、所有虚拟机预留内存之和，不能够大于服务器本身内存大小。


操作系统是如何识别内存？
1、内存地址必须从0开始
2、内存地址必须是连续的

物理服务器上，有多个虚拟机，0只有一个，怎么办？
内存如何连续？
通过内存地址映射
HPA->GPA->GVA


























